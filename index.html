<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>é¹…å”±æ­Œæ£€æµ‹</title>
  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      text-align: center;
      font-family: 'Arial', sans-serif;
    }
    video {
      margin-top: 20px;
      width: 320px;
      height: 240px;
      border: 2px solid #fff;
      border-radius: 10px;
      display: none; /* ç‚¹æŒ‰é’®å‰å…ˆéšè— */
    }
    #status {
      font-size: 36px;
      margin-top: 20px;
      display: none; /* ç‚¹æŒ‰é’®å‰éšè— */
    }
    #goose {
      margin-top: 20px;
      display: none;
      width: 200px;
      height: auto;
    }
    #startButton {
      margin-top: 100px;
      font-size: 24px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: #4CAF50;
      color: white;
      cursor: pointer;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/vision_bundle.mjs" type="module"></script>
</head>
<body>
  <h1>ğŸª¿ é—­çœ¼è®©é¹…å”±æ­Œ ğŸµ</h1>

  <!-- ç‚¹å‡»å¼€å§‹æŒ‰é’® -->
  <button id="startButton">ç‚¹å‡»å¼€å§‹</button>

  <!-- æ‘„åƒå¤´ç”»é¢ -->
  <video id="video" autoplay playsinline></video>

  <!-- çŠ¶æ€æ–‡æœ¬ -->
  <div id="status">åŠ è½½ä¸­...</div>

  <!-- é¹…å›¾ç‰‡ -->
  <img id="goose" src="https://upload.wikimedia.org/wikipedia/commons/7/7b/Goose_icon.png" alt="å”±æ­Œçš„é¹…">

  <!-- é¹…çš„æ­Œ -->
  <audio id="gooseSound" src="ä½ çš„çœŸæ­£mp3é“¾æ¥" loop></audio>

  <script type="module">
    import { FilesetResolver, FaceLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/vision_bundle.mjs";

    const video = document.getElementById('video');
    const statusText = document.getElementById('status');
    const gooseImg = document.getElementById('goose');
    const gooseSound = document.getElementById('gooseSound');
    const startButton = document.getElementById('startButton');

    let isGooseSinging = false;

    startButton.addEventListener('click', async () => {
      // ç”¨æˆ·ç‚¹å‡»åï¼Œéšè—æŒ‰é’®ï¼Œæ˜¾ç¤ºè§†é¢‘å’ŒçŠ¶æ€æ–‡å­—
      startButton.style.display = 'none';
      video.style.display = 'block';
      statusText.style.display = 'block';

      await init(); // ç‚¹äº†ä¹‹åæ‰åˆå§‹åŒ–
    });

    async function init() {
      const vision = await FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
      );

      const faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
        baseOptions: {
          modelAssetPath: "https://storage.googleapis.com/mediapipe-assets/face_landmarker.task",
          delegate: "GPU",
        },
        outputFaceBlendshapes: false,
        outputFacialTransformationMatrixes: false,
        runningMode: "VIDEO",
        numFaces: 1,
      });

      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;

      async function detect() {
        if (video.readyState < 2) {
          requestAnimationFrame(detect);
          return;
        }

        const nowInMs = Date.now();
        const results = faceLandmarker.detectForVideo(video, nowInMs);

        if (results.faceLandmarks.length > 0) {
          const landmarks = results.faceLandmarks[0];

          const leftEyeOpenScore = getEyeOpenScore(landmarks, 159, 145);
          const rightEyeOpenScore = getEyeOpenScore(landmarks, 386, 374);

          const eyeOpen = (leftEyeOpenScore > 0.02) && (rightEyeOpenScore > 0.02);

          if (eyeOpen) {
            statusText.textContent = "è¯·é—­çœ¼ ğŸ’¤";
            gooseImg.style.display = "none";
            if (isGooseSinging) {
              gooseSound.pause();
              gooseSound.currentTime = 0;
              isGooseSinging = false;
            }
          } else {
            statusText.textContent = "é¹…åœ¨å”±æ­Œ ğŸµ";
            gooseImg.style.display = "block";
            if (!isGooseSinging) {
              gooseSound.play().catch(e => {
                console.log("æ’­æ”¾å‡ºé”™ï¼", e);
              });
              isGooseSinging = true;
            }
          }
        } else {
          statusText.textContent = "æœªæ£€æµ‹åˆ°äººè„¸";
          gooseImg.style.display = "none";
          if (isGooseSinging) {
            gooseSound.pause();
            gooseSound.currentTime = 0;
            isGooseSinging = false;
          }
        }

        requestAnimationFrame(detect);
      }

      detect();
    }

    function getEyeOpenScore(landmarks, topIdx, bottomIdx) {
      const top = landmarks[topIdx];
      const bottom = landmarks[bottomIdx];
      const dy = bottom.y - top.y;
      return dy;
    }
  </script>
</body>
</html>
