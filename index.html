<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title>å°é¹…é—­çœ¼å”±æ­Œ - å®Œæ•´ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Material DesignæŒ‰é’®æ ·å¼ -->
  <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
  <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>

  <!-- Tone.js ç”¨äºæ’­æ”¾éŸ³ä¹ -->
  <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.js"></script>

  <!-- MediaPipe Vision Tasks -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js"></script>

  <style>
    body {
      background-color: black;
      color: white;
      text-align: center;
      font-family: sans-serif;
      margin: 20px;
    }
    #goose {
      font-size: 100px;
      margin-top: 30px;
    }
    #gooseMessage {
      font-size: 24px;
      margin-top: 10px;
    }
    video, canvas {
      display: none; /* éšè—æ‘„åƒå¤´ç”»é¢å’Œç»˜å›¾ */
    }
  </style>
</head>

<body>
  <h1>å°é¹…è¯´ï¼šé—­ä¸Šçœ¼ç›æ‰èƒ½å¬éŸ³ä¹å“¦ï½ğŸª¿</h1>

  <div id="goose">ğŸª¿</div>
  <div id="gooseMessage">è¯·ç‚¹å‡»ä¸‹é¢æŒ‰é’®å¼€å¯æ‘„åƒå¤´</div>

  <section id="demos">
    <div id="liveView" class="videoView">
      <button id="webcamButton" class="mdc-button mdc-button--raised" style="margin-top: 20px;">
        <span class="mdc-button__ripple"></span>
        <span class="mdc-button__label">å¼€å¯æ‘„åƒå¤´</span>
      </button>
      <div style="position: relative;">
        <video id="webcam" autoplay playsinline muted></video>
        <canvas class="output_canvas" id="output_canvas"></canvas>
      </div>
    </div>
  </section>

<script>
const goose = document.getElementById('goose');
const gooseMessage = document.getElementById('gooseMessage');
const webcamButton = document.getElementById('webcamButton');
const webcam = document.getElementById('webcam');
const canvasElement = document.getElementById('output_canvas');
let faceLandmarker;
let runningMode = "VIDEO";
let playingMusic = false;

// éŸ³ä¹åˆæˆå™¨
const synth = new Tone.Synth().toDestination();
function playMusic() {
  synth.triggerAttackRelease('C4', '8n');
  synth.triggerAttackRelease('E4', '8n', '+0.5');
  synth.triggerAttackRelease('G4', '8n', '+1');
}

// æ‘„åƒå¤´æ£€æµ‹
async function createFaceLandmarker() {
  const vision = window.vision;
  const filesetResolver = await vision.FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
  );
  faceLandmarker = await vision.FaceLandmarker.createFromOptions(filesetResolver, {
    baseOptions: {
      modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
      delegate: "GPU"
    },
    outputFaceBlendshapes: true,
    runningMode,
    numFaces: 1
  });
}

// æ˜¯å¦æ”¯æŒæ‘„åƒå¤´
function hasGetUserMedia() {
  return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
}

if (hasGetUserMedia()) {
  webcamButton.addEventListener("click", enableCam);
} else {
  alert("ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½ï¼");
}

// å¼€å¯æ‘„åƒå¤´
async function enableCam() {
  Tone.start(); // æ¿€æ´»éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆå¿…é¡»åœ¨ç”¨æˆ·äº¤äº’åï¼‰
  webcamButton.disabled = true;
  webcam.style.display = "none"; // éšè—æ‘„åƒå¤´ç”»é¢
  canvasElement.style.display = "none"; // éšè—ç»˜åˆ¶canvas

  await createFaceLandmarker();

  const constraints = { video: true };
  const stream = await navigator.mediaDevices.getUserMedia(constraints);
  webcam.srcObject = stream;

  webcam.addEventListener("loadeddata", predictWebcam);
}

let lastVideoTime = -1;
async function predictWebcam() {
  if (runningMode === "IMAGE") {
    runningMode = "VIDEO";
    await faceLandmarker.setOptions({ runningMode });
  }

  let nowInMs = Date.now();
  if (lastVideoTime !== webcam.currentTime) {
    lastVideoTime = webcam.currentTime;
    const results = faceLandmarker.detectForVideo(webcam, nowInMs);

    if (results.faceLandmarks && results.faceLandmarks.length > 0) {
      const landmarks = results.faceLandmarks[0];
      const leftEyeTop = landmarks[386];
      const leftEyeBottom = landmarks[374];
      const rightEyeTop = landmarks[159];
      const rightEyeBottom = landmarks[145];

      const leftEyeDist = Math.hypot(leftEyeTop.x - leftEyeBottom.x, leftEyeTop.y - leftEyeBottom.y);
      const rightEyeDist = Math.hypot(rightEyeTop.x - rightEyeBottom.x, rightEyeTop.y - rightEyeBottom.y);

      if (leftEyeDist < 0.01 && rightEyeDist < 0.01) {
        // åˆ¤å®šä¸ºé—­çœ¼
        goose.innerText = "ğŸ¶ğŸª¿ğŸ¶";
        gooseMessage.innerText = "é¹…åœ¨æ¼”å¥éŸ³ä¹ğŸµ";
        if (!playingMusic) {
          playingMusic = true;
          playMusic();
        }
      } else {
        goose.innerText = "ğŸ˜ ğŸª¿";
        gooseMessage.innerText = "å¿«é—­ä¸Šçœ¼ç›ï¼";
        playingMusic = false;
      }
    }
  }

  window.requestAnimationFrame(predictWebcam);
}
</script>

</body>
</html>
