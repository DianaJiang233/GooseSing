<script>
const goose = document.getElementById('goose');
const gooseMessage = document.getElementById('gooseMessage');
const webcamButton = document.getElementById('webcamButton');
const webcam = document.getElementById('webcam');
const canvasElement = document.getElementById('output_canvas');
let faceLandmarker;
let runningMode = "VIDEO";
let playingMusic = false;

// 音乐合成器
const synth = new Tone.Synth().toDestination();
function playMusic() {
  synth.triggerAttackRelease('C4', '8n');
  synth.triggerAttackRelease('E4', '8n', '+0.5');
  synth.triggerAttackRelease('G4', '8n', '+1');
}

// 等待vision加载完成
function waitForVisionAndStart() {
  if (window.vision && window.vision.FilesetResolver) {
    console.log("Vision loaded.");
    createFaceLandmarker();
  } else {
    console.log("Waiting for Vision to load...");
    setTimeout(waitForVisionAndStart, 100); // 每100ms检查一次
  }
}

// 创建检测器
async function createFaceLandmarker() {
  const vision = window.vision;
  const filesetResolver = await vision.FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
  );
  faceLandmarker = await vision.FaceLandmarker.createFromOptions(filesetResolver, {
    baseOptions: {
      modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
      delegate: "GPU"
    },
    outputFaceBlendshapes: true,
    runningMode,
    numFaces: 1
  });

  enableRealCamera(); // Vision加载好之后才能开启摄像头
}

// 开启摄像头
async function enableRealCamera() {
  const constraints = { video: true };
  const stream = await navigator.mediaDevices.getUserMedia(constraints);
  webcam.srcObject = stream;
  webcam.addEventListener("loadeddata", predictWebcam);
}

function hasGetUserMedia() {
  return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
}

if (hasGetUserMedia()) {
  webcamButton.addEventListener("click", () => {
    Tone.start(); // 激活音频
    webcamButton.disabled = true;
    webcam.style.display = "none";
    canvasElement.style.display = "none";
    waitForVisionAndStart(); // 点击按钮后，才开始等待vision加载
  });
} else {
  alert("你的浏览器不支持摄像头功能！");
}

let lastVideoTime = -1;
async function predictWebcam() {
  if (runningMode === "IMAGE") {
    runningMode = "VIDEO";
    await faceLandmarker.setOptions({ runningMode });
  }

  let nowInMs = Date.now();
  if (lastVideoTime !== webcam.currentTime) {
    lastVideoTime = webcam.currentTime;
    const results = faceLandmarker.detectForVideo(webcam, nowInMs);

    if (results.faceLandmarks && results.faceLandmarks.length > 0) {
      const landmarks = results.faceLandmarks[0];
      const leftEyeTop = landmarks[386];
      const leftEyeBottom = landmarks[374];
      const rightEyeTop = landmarks[159];
      const rightEyeBottom = landmarks[145];

      const leftEyeDist = Math.hypot(leftEyeTop.x - leftEyeBottom.x, leftEyeTop.y - leftEyeBottom.y);
      const rightEyeDist = Math.hypot(rightEyeTop.x - rightEyeBottom.x, rightEyeTop.y - rightEyeBottom.y);

      if (leftEyeDist < 0.01 && rightEyeDist < 0.01) {
        goose.innerText = "🎶🪿🎶";
        gooseMessage.innerText = "鹅在演奏音乐🎵";
        if (!playingMusic) {
          playingMusic = true;
          playMusic();
        }
      } else {
        goose.innerText = "😠🪿";
        gooseMessage.innerText = "快闭上眼睛！";
        playingMusic = false;
      }
    }
  }

  window.requestAnimationFrame(predictWebcam);
}
</script>
