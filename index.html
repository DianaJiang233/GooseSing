<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>小鹅闭眼检测 - 稳定版</title>
  <style>
    body {
      background-color: black;
      color: white;
      text-align: center;
      font-family: sans-serif;
      margin-top: 50px;
    }
    #goose {
      font-size: 100px;
      margin-top: 20px;
    }
    #message {
      margin-top: 20px;
      font-size: 24px;
    }
    #startButton {
      margin-top: 30px;
      padding: 10px 20px;
      font-size: 20px;
      border: none;
      border-radius: 8px;
      background-color: white;
      color: black;
      cursor: pointer;
    }
    video {
      display: none;
    }
  </style>
</head>
<body>

<h1>小鹅说：闭上眼睛才能听音乐哦～🪿</h1>

<div id="goose">🪿</div>
<div id="message">请点击下面按钮开始</div>
<button id="startButton">开始</button>

<video id="video" autoplay playsinline muted></video>

<!-- 引入 TensorFlow.js 和 人脸检测模型 -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection"></script>
<script src="https://cdn.jsdelivr.net/npm/tone"></script>

<script>
const goose = document.getElementById('goose');
const message = document.getElementById('message');
const video = document.getElementById('video');
const startButton = document.getElementById('startButton');

let model;
let playingMusic = false;

// 音乐合成器
const synth = new Tone.Synth().toDestination();
function playMusic() {
  synth.triggerAttackRelease('C4', '8n');
  synth.triggerAttackRelease('E4', '8n', '+0.5');
  synth.triggerAttackRelease('G4', '8n', '+1');
}

// 检测眼睛是否闭上（用左眼内外角 landmark）
function isEyesClosed(landmarks) {
  const leftTop = landmarks[159];
  const leftBottom = landmarks[145];
  const distance = Math.hypot(leftTop.x - leftBottom.x, leftTop.y - leftBottom.y);
  return distance < 0.005; // 根据眼睛张开度调整阈值
}

// 点击开始
startButton.addEventListener('click', async () => {
  startButton.style.display = 'none';
  message.innerText = "小鹅说：快闭上眼睛～";

  // 打开摄像头
  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;
  await video.play();

  // 加载模型
  model = await faceLandmarksDetection.load(faceLandmarksDetection.SupportedPackages.mediapipeFacemesh);

  detectLoop();
});

// 循环检测
async function detectLoop() {
  if (!model) return;

  const predictions = await model.estimateFaces({input: video, returnTensors: false});
  
  if (predictions.length > 0) {
    const keypoints = predictions[0].scaledMesh;

    if (isEyesClosed(keypoints)) {
      message.innerText = "鹅在演奏音乐🎵";
      goose.innerText = "🎶🪿🎶";
      if (!playingMusic) {
        playingMusic = true;
        Tone.start();
        playMusic();
      }
    } else {
      message.innerText = "快闭上眼睛！";
      goose.innerText = "😠🪿";
      playingMusic = false;
    }
  } else {
    message.innerText = "小鹅找不到你的脸呢～";
    goose.innerText = "❓🪿";
  }

  requestAnimationFrame(detectLoop);
}
</script>

</body>
</html>
