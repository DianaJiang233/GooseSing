<script>
const goose = document.getElementById('goose');
const gooseMessage = document.getElementById('gooseMessage');
const webcamButton = document.getElementById('webcamButton');
const webcam = document.getElementById('webcam');
const canvasElement = document.getElementById('output_canvas');
let faceLandmarker;
let runningMode = "VIDEO";
let playingMusic = false;

// éŸ³ä¹åˆæˆå™¨
const synth = new Tone.Synth().toDestination();
function playMusic() {
  synth.triggerAttackRelease('C4', '8n');
  synth.triggerAttackRelease('E4', '8n', '+0.5');
  synth.triggerAttackRelease('G4', '8n', '+1');
}

// ç­‰å¾…visionåŠ è½½å®Œæˆ
function waitForVisionAndStart() {
  if (window.vision && window.vision.FilesetResolver) {
    console.log("Vision loaded.");
    createFaceLandmarker();
  } else {
    console.log("Waiting for Vision to load...");
    setTimeout(waitForVisionAndStart, 100); // æ¯100msæ£€æŸ¥ä¸€æ¬¡
  }
}

// åˆ›å»ºæ£€æµ‹å™¨
async function createFaceLandmarker() {
  const vision = window.vision;
  const filesetResolver = await vision.FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
  );
  faceLandmarker = await vision.FaceLandmarker.createFromOptions(filesetResolver, {
    baseOptions: {
      modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
      delegate: "GPU"
    },
    outputFaceBlendshapes: true,
    runningMode,
    numFaces: 1
  });

  enableRealCamera(); // VisionåŠ è½½å¥½ä¹‹åŽæ‰èƒ½å¼€å¯æ‘„åƒå¤´
}

// å¼€å¯æ‘„åƒå¤´
async function enableRealCamera() {
  const constraints = { video: true };
  const stream = await navigator.mediaDevices.getUserMedia(constraints);
  webcam.srcObject = stream;
  webcam.addEventListener("loadeddata", predictWebcam);
}

function hasGetUserMedia() {
  return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
}

if (hasGetUserMedia()) {
  webcamButton.addEventListener("click", () => {
    Tone.start(); // æ¿€æ´»éŸ³é¢‘
    webcamButton.disabled = true;
    webcam.style.display = "none";
    canvasElement.style.display = "none";
    waitForVisionAndStart(); // ç‚¹å‡»æŒ‰é’®åŽï¼Œæ‰å¼€å§‹ç­‰å¾…visionåŠ è½½
  });
} else {
  alert("ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½ï¼");
}

let lastVideoTime = -1;
async function predictWebcam() {
  if (runningMode === "IMAGE") {
    runningMode = "VIDEO";
    await faceLandmarker.setOptions({ runningMode });
  }

  let nowInMs = Date.now();
  if (lastVideoTime !== webcam.currentTime) {
    lastVideoTime = webcam.currentTime;
    const results = faceLandmarker.detectForVideo(webcam, nowInMs);

    if (results.faceLandmarks && results.faceLandmarks.length > 0) {
      const landmarks = results.faceLandmarks[0];
      const leftEyeTop = landmarks[386];
      const leftEyeBottom = landmarks[374];
      const rightEyeTop = landmarks[159];
      const rightEyeBottom = landmarks[145];

      const leftEyeDist = Math.hypot(leftEyeTop.x - leftEyeBottom.x, leftEyeTop.y - leftEyeBottom.y);
      const rightEyeDist = Math.hypot(rightEyeTop.x - rightEyeBottom.x, rightEyeTop.y - rightEyeBottom.y);

      if (leftEyeDist < 0.01 && rightEyeDist < 0.01) {
        goose.innerText = "ðŸŽ¶ðŸª¿ðŸŽ¶";
        gooseMessage.innerText = "é¹…åœ¨æ¼”å¥éŸ³ä¹ðŸŽµ";
        if (!playingMusic) {
          playingMusic = true;
          playMusic();
        }
      } else {
        goose.innerText = "ðŸ˜ ðŸª¿";
        gooseMessage.innerText = "å¿«é—­ä¸Šçœ¼ç›ï¼";
        playingMusic = false;
      }
    }
  }

  window.requestAnimationFrame(predictWebcam);
}
</script>
