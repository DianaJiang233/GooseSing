<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title>小鹅闭眼唱歌 - 完整版</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Material Design按钮样式 -->
  <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
  <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>

  <!-- Tone.js 用于播放音乐 -->
  <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.js"></script>

  <!-- MediaPipe Vision Tasks -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js"></script>

  <style>
    body {
      background-color: black;
      color: white;
      text-align: center;
      font-family: sans-serif;
      margin: 20px;
    }
    #goose {
      font-size: 100px;
      margin-top: 30px;
    }
    #gooseMessage {
      font-size: 24px;
      margin-top: 10px;
    }
    video, canvas {
      display: none; /* 隐藏摄像头画面和绘图 */
    }
  </style>
</head>

<body>
  <h1>小鹅说：闭上眼睛才能听音乐哦～🪿</h1>

  <div id="goose">🪿</div>
  <div id="gooseMessage">请点击下面按钮开启摄像头</div>

  <section id="demos">
    <div id="liveView" class="videoView">
      <button id="webcamButton" class="mdc-button mdc-button--raised" style="margin-top: 20px;">
        <span class="mdc-button__ripple"></span>
        <span class="mdc-button__label">开启摄像头</span>
      </button>
      <div style="position: relative;">
        <video id="webcam" autoplay playsinline muted></video>
        <canvas class="output_canvas" id="output_canvas"></canvas>
      </div>
    </div>
  </section>

<script>
const goose = document.getElementById('goose');
const gooseMessage = document.getElementById('gooseMessage');
const webcamButton = document.getElementById('webcamButton');
const webcam = document.getElementById('webcam');
const canvasElement = document.getElementById('output_canvas');
let faceLandmarker;
let runningMode = "VIDEO";
let playingMusic = false;

// 音乐合成器
const synth = new Tone.Synth().toDestination();
function playMusic() {
  synth.triggerAttackRelease('C4', '8n');
  synth.triggerAttackRelease('E4', '8n', '+0.5');
  synth.triggerAttackRelease('G4', '8n', '+1');
}

// 摄像头检测
async function createFaceLandmarker() {
  const vision = window.vision;
  const filesetResolver = await vision.FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
  );
  faceLandmarker = await vision.FaceLandmarker.createFromOptions(filesetResolver, {
    baseOptions: {
      modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
      delegate: "GPU"
    },
    outputFaceBlendshapes: true,
    runningMode,
    numFaces: 1
  });
}

// 是否支持摄像头
function hasGetUserMedia() {
  return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
}

if (hasGetUserMedia()) {
  webcamButton.addEventListener("click", enableCam);
} else {
  alert("你的浏览器不支持摄像头功能！");
}

// 开启摄像头
async function enableCam() {
  Tone.start(); // 激活音频上下文（必须在用户交互后）
  webcamButton.disabled = true;
  webcam.style.display = "none"; // 隐藏摄像头画面
  canvasElement.style.display = "none"; // 隐藏绘制canvas

  await createFaceLandmarker();

  const constraints = { video: true };
  const stream = await navigator.mediaDevices.getUserMedia(constraints);
  webcam.srcObject = stream;

  webcam.addEventListener("loadeddata", predictWebcam);
}

let lastVideoTime = -1;
async function predictWebcam() {
  if (runningMode === "IMAGE") {
    runningMode = "VIDEO";
    await faceLandmarker.setOptions({ runningMode });
  }

  let nowInMs = Date.now();
  if (lastVideoTime !== webcam.currentTime) {
    lastVideoTime = webcam.currentTime;
    const results = faceLandmarker.detectForVideo(webcam, nowInMs);

    if (results.faceLandmarks && results.faceLandmarks.length > 0) {
      const landmarks = results.faceLandmarks[0];
      const leftEyeTop = landmarks[386];
      const leftEyeBottom = landmarks[374];
      const rightEyeTop = landmarks[159];
      const rightEyeBottom = landmarks[145];

      const leftEyeDist = Math.hypot(leftEyeTop.x - leftEyeBottom.x, leftEyeTop.y - leftEyeBottom.y);
      const rightEyeDist = Math.hypot(rightEyeTop.x - rightEyeBottom.x, rightEyeTop.y - rightEyeBottom.y);

      if (leftEyeDist < 0.01 && rightEyeDist < 0.01) {
        // 判定为闭眼
        goose.innerText = "🎶🪿🎶";
        gooseMessage.innerText = "鹅在演奏音乐🎵";
        if (!playingMusic) {
          playingMusic = true;
          playMusic();
        }
      } else {
        goose.innerText = "😠🪿";
        gooseMessage.innerText = "快闭上眼睛！";
        playingMusic = false;
      }
    }
  }

  window.requestAnimationFrame(predictWebcam);
}
</script>

</body>
</html>
