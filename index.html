<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>é—­ä¸Šçœ¼ç›çš„å°é¹…ï¼ˆæœ€ç»ˆç‰ˆï¼‰</title>
  <style>
    body {
      background-color: black;
      color: white;
      text-align: center;
      font-family: sans-serif;
      margin-top: 50px;
    }
    #goose {
      font-size: 100px;
      margin-top: 20px;
    }
    #message {
      margin-top: 20px;
      font-size: 24px;
    }
    #startButton {
      margin-top: 30px;
      padding: 10px 20px;
      font-size: 20px;
      border: none;
      border-radius: 8px;
      background-color: white;
      color: black;
      cursor: pointer;
    }
    video {
      display: none;
    }
  </style>
</head>
<body>

<h1>å°é¹…è¯´ï¼šé—­ä¸Šçœ¼ç›æ‰èƒ½å¬éŸ³ä¹å“¦ï½ğŸª¿</h1>

<div id="goose">ğŸª¿</div>
<div id="message">è¯·ç‚¹å‡»ä¸‹é¢æŒ‰é’®å¼€å§‹</div>
<button id="startButton">å¼€å§‹</button>

<video id="video" autoplay playsinline muted></video>

<!-- âœ… æ­£ç¡®åŠ è½½å…¨å±€FaceMesh -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.js"></script>

<script>
const goose = document.getElementById('goose');
const message = document.getElementById('message');
const video = document.getElementById('video');
const startButton = document.getElementById('startButton');

let playingMusic = false;

// éŸ³ä¹åˆæˆå™¨
const synth = new Tone.Synth().toDestination();
function playMusic() {
  synth.triggerAttackRelease('C4', '8n');
  synth.triggerAttackRelease('E4', '8n', '+0.5');
  synth.triggerAttackRelease('G4', '8n', '+1');
}

// æ£€æµ‹çœ¼ç›æ˜¯å¦é—­ä¸Š
function isEyesClosed(landmarks) {
  const top = landmarks[159];
  const bottom = landmarks[145];
  const distance = Math.hypot(top.x - bottom.x, top.y - bottom.y);
  return distance < 0.01; // çœ¼ç›å‚ç›´è·ç¦»å°ï¼Œè¯´æ˜é—­ä¸Šäº†
}

// åˆå§‹åŒ–FaceMesh
const faceMesh = new FaceMesh.FaceMesh({
  locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
});

faceMesh.setOptions({
  maxNumFaces: 1,
  refineLandmarks: true,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});

faceMesh.onResults(results => {
  if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
    const landmarks = results.multiFaceLandmarks[0];
    if (isEyesClosed(landmarks)) {
      message.innerText = "é¹…åœ¨æ¼”å¥éŸ³ä¹ğŸµ";
      goose.innerText = "ğŸ¶ğŸª¿ğŸ¶";
      if (!playingMusic) {
        playingMusic = true;
        Tone.start();
        playMusic();
      }
    } else {
      message.innerText = "å¿«é—­ä¸Šçœ¼ç›ï¼";
      goose.innerText = "ğŸ˜ ğŸª¿";
      playingMusic = false;
    }
  }
});

// ç‚¹å‡»å¼€å§‹
startButton.addEventListener('click', async () => {
  startButton.style.display = 'none';
  message.innerText = "å°é¹…è¯´ï¼šå¿«é—­ä¸Šçœ¼ç›ï½";

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
    await video.play();

    const camera = new CameraUtils.Camera(video, {
      onFrame: async () => {
        await faceMesh.send({ image: video });
      },
      width: 640,
      height: 480
    });
    camera.start();

  } catch (e) {
    console.error("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥", e);
    message.innerText = "æ— æ³•æ‰“å¼€æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™ã€‚";
    goose.innerText = "âŒğŸª¿";
  }
});
</script>

</body>
</html>
